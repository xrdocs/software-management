---
published: false
date: '2017-12-06 16:12 -0800'
title: IOS-XR NSO Integration Part 1 (Using PnP)
---
# Introduction
Network Services Orchestrator is a Cisco tool that provides end-to-end orchestration that spans multiple domains in your network. Using strict, standardized YANG models for both services and devices and a highly efficient abstraction layer between your network services and the underlying infrastructure, the orchestrator lets you automate Cisco and other vendor's devices.

## PnP

The NSO PnP Server is a NSO Component which enables management of Cisco PnP clients. The NSO PnP Server provides the Cisco PnP clients with configuration, typically configuration needed at the first boot of the client (Day-0 configuration). 

## ZTP
ZTP does not currently include PnP capabilities, in this article we will go other a method that use the ZTP feature of IOS-XR together with a Cisco PnP agent to automatically deploy a Day-0 configuration and register a new device to the NSO server.

At the end of this process, NSO will be able to initiate a connection to the device (through a Netconf NED or a CLI NED), execute a "sync-from" command and deploy a service thanks to the reactive FASTMAP feature.

We will use the ZTP feature that allows to download and execute a shell script during initial bootup. This script (pre-agg.sh in our example) will do the following tasks:

* Downloads on the device a Docker container embedding the PnP agent.

* Downloads and applies a basic configuration enabling netconf on the device.

* Download and applies a configuration for the PnP agent.

* Launch the container.

The PnP agent will be in charge of notifying the NSO server that the device has completed its bootup sequence and will perform a 4-way handshake with the NSO server.
The PnP server will start by sending a Day-0 configuration, the PnP agent will apply it and finally the server will register the device into the NSO CDB.
After the third PnP Work Request, the PnP Server package triggers a sync-from and the reactive FASTMAP mechanism to deploy services.

## The PnP Agent

PnP is a protocol that allows a day-0 configuration of a device using a back-end server. The server must identifies the device (or agent) with its serial number.This rxample does not use PnP credentials and has not been tested using HTTPS.

The PnP agent will look for a configuration file in the host file system (/root/config/cisco-pnp-agent.conf) that has been made available inside the container.

PnP workflow that has been tested:

* PnP Hello 4-way handshake between server and agent.

* PnP agent sends PnP Work Request

* Server sends the block of configuration lines.

* PnP agent apply each line one by one and check for syntax error, incomplete command or commit error and sends a response to the server.

Since the agent resides inside a container, it must communicate with the XR control plane through the network. The container uses the fwd_ew interface and the Loopback1 IP address.

The agent uses SSH to access XR console. For all these reasons, the PnP Agent configuration file must include the Loopback 1 IP address and valid credentials for SSH. The file cisco-pnp-agent.conf is an example of configuration, this file is automatically generated by the bash script during the ZTP process in our example (see pre-agg.sh).

## DHCP configuration
For ZTP to operate a valid IPv4/IPv6 address is required and the DHCP server must send a pointer to the configuration script via option 67. Here is an example of configuration

```
#
# DHCP Server Configuration file.
#
allow bootp;
allow booting;
ddns-update-style interim;
option time-offset -8;
ignore client-updates;
default-lease-time 300;
log-facility local7;
authoritative;

subnet 192.168.1.0 netmask 255.255.255.0 {
  option subnet-mask                  255.255.255.0;
  option broadcast-address            192.168.1.255;
  option routers                      192.168.1.1;
  option domain-name-servers          192.168.1.10;
  option domain-name                  "cisco.local";
}
host ncs-5001-1 {
  option dhcp-client-identifier    "FOC2018R1QU";
  fixed-address                    192.168.1.16;
  if exists user-class and option user-class = "iPXE" {
    filename = "http://192.168.2.10/ipxe/ncs5k.ipxe";
  } elsif exists user-class and option user-class = "exr-config" {
    filename = "http://192.168.2.10/scripts/pre-agg.sh";
  }
}
```
