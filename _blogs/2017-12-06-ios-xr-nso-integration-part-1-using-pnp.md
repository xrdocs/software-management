---
published: false
date: '2017-12-06 16:12 -0800'
title: IOS-XR NSO Integration Part 1 (Using PnP)
---
# Introduction
Network Services Orchestrator is a Cisco tool that provides end-to-end orchestration that spans multiple domains in your network. Using strict, standardized YANG models for both services and devices and a highly efficient abstraction layer between your network services and the underlying infrastructure, the orchestrator lets you automate Cisco and other vendor's devices.

## PnP

The NSO PnP Server is a NSO Component which enables management of Cisco PnP clients. The NSO PnP Server provides the Cisco PnP clients with configuration, typically configuration needed at the first boot of the client (Day-0 configuration). 

## ZTP
ZTP does not currently include PnP capabilities, in this article we will go other a method that use the ZTP feature of IOS-XR together with a Cisco PnP agent to automatically deploy a Day-0 configuration and register a new device to the NSO server.

At the end of this process, NSO will be able to initiate a connection to the device (through a Netconf NED or a CLI NED), execute a "sync-from" command and deploy a service thanks to the reactive FASTMAP feature.

We will use the ZTP feature that allows to download and execute a shell script during initial bootup. This script (pnp_agent.sh in our example) will do the following tasks:

* Downloads on the device a Docker container embedding the PnP agent.

* Downloads and applies a basic configuration enabling netconf on the device.

* Download and applies a configuration for the PnP agent.

* Launch the container.

The PnP agent will be in charge of notifying the NSO server that the device has completed its bootup sequence and will perform a 4-way handshake with the NSO server.
The PnP server will start by sending a Day-0 configuration, the PnP agent will apply it and finally the server will register the device into the NSO CDB.
After the third PnP Work Request, the PnP Server package triggers a sync-from and the reactive FASTMAP mechanism to deploy services.

## The PnP Agent

PnP is a protocol that allows a day-0 configuration of a device using a back-end server. The server must identifies the device (or agent) with its serial number.This rxample does not use PnP credentials and has not been tested using HTTPS.

The PnP agent will look for a configuration file in the host file system (/root/config/cisco-pnp-agent.conf) that has been made available inside the container.

PnP workflow that has been tested:

* PnP Hello 4-way handshake between server and agent.

* PnP agent sends PnP Work Request

* Server sends the block of configuration lines.

* PnP agent apply each line one by one and check for syntax error, incomplete command or commit error and sends a response to the server.

Since the agent resides inside a container, it must communicate with the XR control plane through the network. The container uses the fwd_ew interface and the Loopback1 IP address.

The agent uses SSH to access XR console. For all these reasons, the PnP Agent configuration file must include the Loopback 1 IP address and valid credentials for SSH. The file cisco-pnp-agent.conf is an example of configuration, this file is automatically generated by the bash script during the ZTP process in our example (see pnp_agent.sh).

## DHCP configuration
For ZTP to operate a valid IPv4/IPv6 address is required and the DHCP server must send a pointer to the configuration script via option 67. Here is an example of configuration

```
#
# DHCP Server Configuration file.
#
allow bootp;
allow booting;
ddns-update-style interim;
option time-offset -8;
ignore client-updates;
default-lease-time 300;
log-facility local7;
authoritative;

subnet 192.168.1.0 netmask 255.255.255.0 {
  option subnet-mask                  255.255.255.0;
  option broadcast-address            192.168.1.255;
  option routers                      192.168.1.1;
  option domain-name-servers          192.168.1.10;
  option domain-name                  "cisco.local";
}
host ncs-5001-1 {
  option dhcp-client-identifier    "FOC2018R1QU";
  fixed-address                    192.168.1.16;
  if exists user-class and option user-class = "iPXE" {
    filename = "http://192.168.2.10/ipxe/ncs5k.ipxe";
  } elsif exists user-class and option user-class = "exr-config" {
    filename = "http://192.168.2.10/scripts/pnp_agent.sh";
  }
}
```
## ZTP script
The ZTP script will do the following operations:

1. Install the K9SEC package.
2. Create a general purpose key.
3. Apply a basic configuration that allow the PnP agent to communicate with the NSO server.
4. Create a simple configuration file for the PnP agent.
5. Import the PnP agent.
6. Launch the PnP agent.

```
#!/bin/bash
#
#  Copyright (c) 2017 Cisco Systems
#  PnP with IOS XR ZTP
#  Author: mtache and pwariche.
#

# Script
export LOGFILE=/disk0:/ztp/user-script.log

# HTTP Server
export HTTP_SERVER=http://192.168.2.10
export CONTAINER_PATH=containers
export RPM_PATH=rpm
export PNP_AGENT_TAR=cisco-pnp-agent.tar
export K9SEC_RPM=ncs5k-k9sec-3.2.0.0-r6225.x86_64

# PnP Agent
export SERIAL_NUMBER = $(dmidecode | grep "Serial Number" | head -n1 | sed -n -e 's/^.*Serial Number: //p')
export PNP_SERVER=http://192.168.2.11:9455
export XR_LOOPBACK_IP=1.1.1.1
export PNP_CONF_PATH=/misc/app_host/etc/pnp-agent
export PNP_CONF_FILE=${PNP_CONF_PATH}/cisco-pnp-agent.conf
export PNP_USER=pnp-user
export PNP_PASSWD="cisco123"

source ztp_helper.sh

function ztp_log() {
   # Sends logging information to local file
   echo "$(date +"%b %d %H:%M:%S") "$1 | /usr/bin/tee -a $LOGFILE
}

function download_pnp(){
   # Downloads Cisco PnP Agent container
   ztp_log "### Downloading PnP Agent container ###";
   /usr/bin/curl -L ${HTTP_SERVER}/${CONTAINER_PATH}/${PNP_AGENT_TAR} -o /disk0:/${PNP_AGENT_TAR} 2>&1 >> $LOGFILE
   if [[ "$?" != 0 ]]; then
      ztp_log "### Error downloading PnP Agent container ###"
   else
      ztp_log "### Downloading PnP Agent container complete ###";
      ztp_log "### Adding PnP Agent container to Docker daemon ###";
      export DOCKER_HOST=unix:///misc/app_host/docker.sock && /usr/bin/bunzip2 -c /disk0:/${PNP_AGENT_TAR} | /usr/bin/docker load 2>&1 >> $LOGFILE
      if [[ "$?" != 0 ]]; then
          ztp_log "### Error loading PnP Agent container into Docker daemon ###"
      else
          ztp_log "### Loaded PnP Agent container into Docker daemon successfully ###"
          PNP_IMAGE_ID=$(docker images -q | sed -n 1p)
      fi
      /bin/rm -f /disk0:/${PNP_AGENT_TAR}
   fi
}

function install_k9sec_pkg(){
   # Installs the k9sec package from repository, create a RSA key modulus 1024
   ztp_log "### Installing XR K9SEC package ###"
   /usr/bin/wget ${HTTP_SERVER}/${RPM_PATH}/${K9SEC_RPM} -O /disk0:/$K9SEC_RPM 2>&1
   if [[ "$?" != 0 ]]; then
      ztp_log "### Error downloading $K9SEC_RPM ###"
   else
      ztp_log "### Downloading $K9SEC_PKG complete ###";
   fi
   xrcmd "install update source /disk0:/ $K9SEC_RPM" 2>&1 >> $LOGFILE
   local complete=0
   while [ "$complete" = 0 ]; do
      complete=`xrcmd "show install active" | grep k9sec | head -n1 | wc -l`
      ztp_log "Waiting for k9sec package to be activated"
      sleep 5
   done
   rm -f /disk0:/$K9SEC_RPM
   ztp_log "### XR K9SEC package install complete ###"
}

function generate_ssh_key() {
  # Create a RSA key modulus 1024
  ztp_log "### Generating SSH Key ###";
  if [[ -z $(xrcmd "show crypto key mypubkey rsa") ]]; then
      echo "1024" | xrcmd "crypto key generate rsa"
  else
      echo -ne "yes\n 1024\n" | xrcmd "crypto key generate rsa"
  fi
  ztp_log "### SSH Key generated ###";
}

function create_pnp_config() {
  # Configures IOS-XR for Cisco PnP agent and creates the configration file
  ztp_log "### Creating PnP Agent configuration ###";
  /bin/rm -f ${PNP_CONF_FILE}
  /bin/mkdir -p ${PNP_CONF_PATH}
  xrapply_string_with_reason "PnP Agent Configuration - Loopback Address" "ssh server v2\n interface Loopback1\n description Required by the PnP Agent\n ipv4 address ${XR_LOOPBACK_IP}/32\n"
  xrapply_string_with_reason "PnP Agent Configuration - PnP User" "username pnp-user\n group root-lr\n group cisco-support\n secret ${PNP_PASSWD}\n"
  echo "SERIAL_NUMBER=${SERIAL_NUMBER}" >> ${PNP_CONF_FILE}
  echo "PNP_SERVER=${PNP_SERVER}" >> ${PNP_CONF_FILE}
  echo "IOS_XR_LOOPBACK_ADDRESS=${XR_LOOPBACK_IP}" >> ${PNP_CONF_FILE}
  echo "PNP_USER=${PNP_USER}" >> ${PNP_CONF_FILE}
  echo "PNP_PASSWORD=${PNP_PASSWD}" >> ${PNP_CONF_FILE}
  ztp_log "### PnP Agent configuration created ###";
}

function run_pnp(){
  ztp_log "### Executing Cisco PnP Agent ###";
  if [[ -z ${PNP_IMAGE_ID} ]]; then
    ztp_log "### Did not find image ID, PnP Agent is not running ###";
  else
    create_pnp_config;
    export DOCKER_HOST=unix:///misc/app_host/docker.sock && /usr/bin/docker run -dit --net=host --name cisco-pnp-agent -v ${PNP_CONF_PATH}:/root/config ${PNP_IMAGE_ID}
  fi
}

function wait_pnp(){
  COUNTER=0
  MAX_COUNTER=36
  SLEEP_TIME=5
  complete=0
  while [ "$complete" = 0 ]; do
    sleep $SLEEP_TIME
    complete=`xrcmd "show running-config" | grep username | grep -v pnp-user | grep -v ztp-user | wc -l`
    COUNTER=$[$COUNTER +1]
    ztp_log "Waiting for PnP Agent to apply Day-0 configuration : $(($COUNTER*$SLEEP_TIME))/$(($MAX_COUNTER*$SLEEP_TIME)) seconds";
    if [ "$COUNTER" = "$MAX_COUNTER" ]; then # Timeout is 1 min
       break
    fi
  done
  if [ "$complete" = 0 ]; then
    xrapply_string_with_reason "Revert PnP Agent Configuration" "no username pnp-user\n no ssh server v2\n no interface Loopback1\n"
    ztp_log "Day-0 configuration not found, reverting PnP Agent configuration";
  fi
}

# ==== Script entry point ====
ztp_log "### Starting autoprovision process... ###";
if [[ -z $(rpm -q $K9SEC_RPM) ]]; then
  install_k9sec_pkg;
fi
generate_ssh_key;  
download_pnp;
run_pnp;
ztp_log "### Waiting for PnP Agent to apply Day-0 configuration... ###";
wait_pnp;
ztp_log "### Autoprovision complete... ###"
exit 0
```
## NSO PnP Configuration
On the NSO server side we will have to install the pnp package, the ios-xr package and configure some credential.

```
admin@ncs(config)# pnp server ip-address 172.30.0.29
admin@ncs(config)# pnp server port 9455
admin@ncs(config)# devices authgroups group default umap system remote-name pnp-user remote-password cisco123
admin@ncs(config)# devices authgroups group default umap admin remote-name pnp-user remote-password cisco123
admin@ncs(config)# pnp map FOC1947R143
admin@ncs(config-map-FOC1947R143)# port 9455
admin@ncs(config-map-FOC1947R143)# device-name ncs5001-1
admin@ncs(config-map-FOC1947R143)# username pnp-user
admin@ncs(config-map-FOC1947R143)# device-type cli
admin@ncs(config-map-FOC1947R143)# ned-id cisco-iosxr
admin@ncs(config-map-FOC1947R143)# day0-file ncs-5001-1_day0.conf
```

Then we have to create the Day-0 configuration file

```
vi ncs-run/packages/cisco-pnp/cfg/ncs-5001-1_day0.conf
```
